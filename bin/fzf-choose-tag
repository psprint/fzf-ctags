#!/usr/bin/env bash
if [[ $1 == symbol-only ]]; then
    q=2
elif [[ -z $1 || $1 = text ]]; then
    q=1
fi

# Sort out the symbol to open at.
line=$(fzf --delimiter '\177' --with-nth $q < <( sed -r -e 's/^\s+//' \
    -e 's/[\x01\x02]/\x7f/g' TAGS.z ))
ret=$?

# Check if anything has been picked.
if (( ret != 0 )) || [[ -z $line ]]; then
    printf "\e[38;5;208mNo symbol has been picked out, nothing to doâ€¦\e[0m\n"
    exit 1
fi

# Split into array.
IFS=$'\x7f' arr=($line)
nr=${arr[2]%%,*}

# Use the user's configured editor falling back to vim.
ed="${VISUAL:-${EDITOR:-vim}}"

printf "\nPicked: \e[1;38;5;39m${arr[1]}\e[0m, opening: \
\e[1;38;5;70m$ed\e[0m with the file: \e[1;38;5;140m${arr[3]}\e[0m:\e[38;5;208m$nr\e[0m\n"

# Allow ** glob
shopt -s globstar

# Run editor on the selected file and line.
# The one-time loop is to emphasize the final step.
while 
    command $ed +$nr **/${arr[3]}
    false
do true; done

